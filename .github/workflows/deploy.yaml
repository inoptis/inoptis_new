name: Build and Deploy
on: [push]

jobs:
  check_commit:
    runs-on: ubuntu-latest
    outputs:
      should_run: ${{ steps.check_message.outputs.should_run }}
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 2

      - name: Check commit message
        id: check_message
        run: |
          commit_message=$(git log -1 --pretty=%B)
          if [[ $commit_message == *"#ignore"* ]]; then
            echo "should_run=false" >> $GITHUB_OUTPUT
          else
            echo "should_run=true" >> $GITHUB_OUTPUT
          fi

  build:
    needs: check_commit
    if: needs.check_commit.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Set engineer tg username
        run: |
          case "${{ github.actor }}" in
            IvanGudyushkin) echo "TG_USERNAME=@Ivanandreevichgud" >> $GITHUB_ENV ;;
            AlexUner) echo "TG_USERNAME=@AlexUner" >> $GITHUB_ENV ;;
            WarningNotError) echo "TG_USERNAME=@eugenroot1" >> $GITHUB_ENV ;;
          esac

      - name: Set custom messages
        run: |
          echo "CUSTOM_MESSAGE_BAD=üí© ${{ env.TG_USERNAME }}, –∏–¥–∏ —É–±–∏—Ä–∞–π –∫–∞–∫–∞—Ö–∏!" >> $GITHUB_ENV
          echo "CUSTOM_MESSAGE_GOOD=üèÜ ${{ env.TG_USERNAME }}, –º–æ–ª–æ–¥–µ—Ü!" >> $GITHUB_ENV

      - name: Install Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install

      - name: Build
        run: npm run build

      - name: Archive production artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build
          path: build/

      - name: Send Telegram Notification on Failure build
        if: failure()
        run: |
          curl -s -X POST https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage \
          --header 'Content-Type: application/json' \
          --data-raw '{
            "chat_id": "${{ secrets.TELEGRAM_CHAT_ID }}",
            "text": "–ü—Ä–æ–µ–∫—Ç: ${{ github.repository }}\nüö® 1/2. –°–±–æ—Ä–∫–∞ –ø—Ä–æ–≤–∞–ª–µ–Ω–∞!\n${{ env.CUSTOM_MESSAGE_BAD }}\n‚ÄºÔ∏è –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ —Å–±–æ—Ä–∫–∏ –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏.",
            "reply_markup": {
              "inline_keyboard": [
                [
                  { "text": "–ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ª–æ–≥–∏ ü§®", "url": "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}" }
                ],
                [
                  { "text": "–ü–∞–π–¥—É —á–∏–Ω–∏—Ç—å ü•∫", "callback_data": "DEPLOY_DELETE:${{ env.TG_USERNAME }}" }
                ]
              ]
            }
          }'

      - name: Send Telegram Notification on Success build
        if: success()
        run: |
          curl -s -X POST https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage \
          --header 'Content-Type: application/json' \
          --data-raw '{
            "chat_id": "${{ secrets.TELEGRAM_CHAT_ID }}",
            "text": "–ü—Ä–æ–µ–∫—Ç: ${{ github.repository }}\n‚úÖ 1/2. –°–±–æ—Ä–∫–∞ —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!\n${{ env.CUSTOM_MESSAGE_GOOD }}\n",
            "reply_markup": {
              "inline_keyboard": [
                [
                  { "text": "–ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ª–æ–≥–∏ ü§®", "url": "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}" }
                ],
                [
                  { "text": "–ù–∏—à—Ç—è–∫ ü§§", "callback_data": "DEPLOY_DELETE:${{ env.TG_USERNAME }}" }
                ]
              ]
            }
          }'

  deploy:
    needs: [check_commit, build]
    if: needs.check_commit.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Set engineer tg username
        run: |
          case "${{ github.actor }}" in
            IvanGudyushkin) echo "TG_USERNAME=@Ivanandreevichgud" >> $GITHUB_ENV ;;
            AlexUner) echo "TG_USERNAME=@AlexUner" >> $GITHUB_ENV ;;
            WarningNotError) echo "TG_USERNAME=@eugenroot1" >> $GITHUB_ENV ;;
          esac

      - name: Set custom messages
        run: |
          echo "CUSTOM_MESSAGE_BAD=üí© ${{ env.TG_USERNAME }}, –∏–¥–∏ —É–±–∏—Ä–∞–π –∫–∞–∫–∞—Ö–∏!" >> $GITHUB_ENV
          echo "CUSTOM_MESSAGE_GOOD=üèÜ ${{ env.TG_USERNAME }}, –º–æ–ª–æ–¥–µ—Ü!" >> $GITHUB_ENV

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build
          path: build/

      - name: FTP Deploy
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ secrets.SFTP_SERVER }}
          username: ${{ secrets.SFTP_USERNAME }}
          password: ${{ secrets.SFTP_PASSWORD }}
          local-dir: build/
          server-dir: ${{ secrets.SITE_FOLDER }}

      - name: Clear MODX Cache
        run: curl ${{ secrets.CACHE_REFRESH_API }}

      - name: Send Telegram Notification on Deploy Failure
        if: failure()
        run: |
          curl -s -X POST https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage \
          --header 'Content-Type: application/json' \
          --data-raw '{
            "chat_id": "${{ secrets.TELEGRAM_CHAT_ID }}",
            "text": "–ü—Ä–æ–µ–∫—Ç: ${{ github.repository }}\nüö® 2/2. –†–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏–µ –Ω–µ —É–¥–∞–ª–æ—Å—å!\n${{ env.CUSTOM_MESSAGE_BAD }}\n‚ÄºÔ∏è –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ —Å–±–æ—Ä–∫–∏ –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏.",
            "reply_markup": {
              "inline_keyboard": [
                [
                  { "text": "–ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ª–æ–≥–∏ ü§®", "url": "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}" }
                ],
                [
                  { "text": "–ü–∞–π–¥—É —á–∏–Ω–∏—Ç—å ü•∫", "callback_data": "DEPLOY_DELETE:${{ env.TG_USERNAME }}" }
                ]
              ]
            }
          }'

      - name: Send Telegram Notification on Deploy Success
        if: success()
        run: |
          curl -s -X POST https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage \
          --header 'Content-Type: application/json' \
          --data-raw '{
            "chat_id": "${{ secrets.TELEGRAM_CHAT_ID }}",
            "text": "–ü—Ä–æ–µ–∫—Ç: ${{ github.repository }}\nüöÄ 2/2. –†–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!\n${{ env.CUSTOM_MESSAGE_GOOD }}\n",
            "reply_markup": {
              "inline_keyboard": [
                [
                  { "text": "–ü–µ—Ä–µ–π—Ç–∏ –Ω–∞ —Å–∞–π—Ç!", "url": "https://inoptis.ru/" }
                ],
                [
                  { "text": "–ù–∏—à—Ç—è–∫ ü§§", "callback_data": "DEPLOY_DELETE:${{ env.TG_USERNAME }}" }
                ]
              ]
            }
          }'
